//****************************************************************************
// epl_1588.h
// 
// Copyright (c) 2006-2008 National Semiconductor Corporation.
// All Rights Reserved
// 
// This file contains all of the 1588/PTP related definitions and prototypes
//
//****************************************************************************

#ifndef _EPL_1588_INCLUDE
#define _EPL_1588_INCLUDE

#include "HL_hal_stdtypes.h"

#define EXPORT
#define IN
#define OUT

// Adj for pin input delay and edge detection time (35ns = 8ns(refclk) * 4 + 3)
#define	PIN_INPUT_DELAY		35

// 1588 Related Definitions
#define TRGOPT_PULSE        0x00000001
#define TRGOPT_PERIODIC     0x00000002
#define TRGOPT_TRG_IF_LATE  0x00000004
#define TRGOPT_NOTIFY_EN    0x00000008
#define TRGOPT_TOGGLE_EN    0x00000010

#define TXOPT_DR_INSERT     0x00000001
#define TXOPT_IGNORE_2STEP  0x00000002
#define TXOPT_CRC_1STEP     0x00000004
#define TXOPT_CHK_1STEP     0x00000008
#define TXOPT_IP1588_EN     0x00000010
#define TXOPT_L2_EN         0x00000020
#define TXOPT_IPV6_EN       0x00000040
#define TXOPT_IPV4_EN       0x00000080
#define TXOPT_TS_EN         0x00000100
#define TXOPT_SYNC_1STEP    0x00000200
#define TXOPT_NTP_TS_EN     0x00001000

#define STSOPT_LITTLE_ENDIAN    0x00000001
#define STSOPT_IPV4             0x00000002
#define STSOPT_TXTS_EN          0x00000004
#define STSOPT_RXTS_EN          0x00000008
#define STSOPT_TRIG_EN          0x00000010
#define STSOPT_EVENT_EN         0x00000020
#define STSOPT_ERR_EN           0x00000040
#define STSOPT_PCFR_EN          0x00000080

#define RXOPT_DOMAIN_EN         0x00000001
#define RXOPT_ALT_MAST_DIS      0x00000002
#define RXOPT_USER_IP_EN        0x00000008
#define RXOPT_RX_SLAVE          0x00000010
#define RXOPT_IP1588_EN0        0x00000020
#define RXOPT_IP1588_EN1        0x00000040
#define RXOPT_IP1588_EN2        0x00000080
#define RXOPT_RX_L2_EN          0x00000100
#define RXOPT_RX_IPV6_EN        0x00000200
#define RXOPT_RX_IPV4_EN        0x00000400
#define RXOPT_SRC_ID_HASH_EN    0x00000800
#define RXOPT_RX_TS_EN          0x00001000
#define RXOPT_ACC_UDP           0x00002000
#define RXOPT_ACC_CRC           0x00004000
#define RXOPT_TS_APPEND         0x00008000
#define RXOPT_TS_INSERT         0x00010000
#define RXOPT_IPV4_UDP_MOD      0x00020000
#define RXOPT_TS_SEC_EN         0x00040000

typedef enum
{
    STS_SRC_ADDR_1 = 0x00000003,
    STS_SRC_ADDR_2 = 0x00000000,
    STS_SRC_ADDR_3 = 0x00000001,
    STS_SRC_ADDR_USE_MC = 0x00000002
} MAC_SRC_ADDRESS_ENUM;


typedef struct RX_CFG_ITEMS
{
    NS_UINT ptpVersion;
    NS_UINT ptpFirstByteMask;
    NS_UINT ptpFirstByteData;
    NS_UINT32 ipAddrData;
    NS_UINT tsMinIFG;
    NS_UINT srcIdHash;
    NS_UINT ptpDomain;
    NS_UINT tsSecLen;
    NS_UINT rxTsNanoSecOffset;
    NS_UINT rxTsSecondsOffset;
} RX_CFG_ITEMS;

#define CLKOPT_CLK_OUT_EN           0x00000001
#define CLKOPT_CLK_OUT_SEL          0x00000002
#define CLKOPT_CLK_OUT_SPEED_SEL    0x00000004

typedef enum PHYMSG_MESSAGE_TYPE_ENUM {
    PHYMSG_STATUS_TX,
    PHYMSG_STATUS_RX,
    PHYMSG_STATUS_TRIGGER,
    PHYMSG_STATUS_EVENT,
    PHYMSG_STATUS_ERROR,
    PHYMSG_STATUS_REG_READ
} PHYMSG_MESSAGE_TYPE_ENUM;

typedef union PHYMSG_MESSAGE {
    struct {
        NS_UINT32 txTimestampSecs;
        NS_UINT32 txTimestampNanoSecs;
        NS_UINT8  txOverflowCount;          // 2-bit value in 8-bit variable
    } TxStatus;

    struct {
        NS_UINT32 rxTimestampSecs;
        NS_UINT32 rxTimestampNanoSecs;
        NS_UINT8  rxOverflowCount;          // 2-bits data in 8-bit variable
        NS_UINT16 sequenceId;               // 16-bits
        NS_UINT8  messageType;              // 4-bits data in 8 bit variable
        NS_UINT16 sourceHash;               // 12-bit data in 16-bit variable
    } RxStatus;

    struct {
        NS_UINT16 triggerStatus;            // Bits [11:0] indicating what triggers occurred (12 - 1 respectively).
    } TriggerStatus;

    struct {
        NS_UINT16 ptpEstsRegBits;           // 12-bits - See PTP_ESTS register for bit definitions
        NS_BOOL   extendedEventStatusFlag;  // 8-bits  - Set to TRUE if ext. info available
        NS_UINT16 extendedEventInfo;        // See register definition for more info
        NS_UINT32 evtTimestampSecs;
        NS_UINT32 evtTimestampNanoSecs;
    } EventStatus;

    struct {
        NS_BOOL frameBufOverflowFlag;       // 8-bits
        NS_BOOL frameCounterOverflowFlag;   // 8-bits
    } ErrorStatus;

    struct {
        NS_UINT8 regIndex;                  // 5-bits data in 8-bit variable
        NS_UINT8 regPage;                   // 3-bits data in 8-bit variable
        NS_UINT16 readRegisterValue;        // 16-bits
    } RegReadStatus;
} PHYMSG_MESSAGE;

typedef struct PHYMSG_LIST {
    PHYMSG_MESSAGE_TYPE_ENUM msgType;
    PHYMSG_MESSAGE      phyMsg;
    struct PHYMSG_LIST  *nxtMsg;
} PHYMSG_LIST;

#define PTPEVT_TRANSMIT_TIMESTAMP_BIT   0x00000001
#define PTPEVT_RECEIVE_TIMESTAMP_BIT    0x00000002
#define PTPEVT_EVENT_TIMESTAMP_BIT      0x00000004
#define PTPEVT_TRIGGER_DONE_BIT         0x00000008

#define PTP_EVENT_PACKET_LENGTH         93

// EPL Function Prototypes
#ifdef __cplusplus
extern "C" {
#endif

void
    PTPEnable(
//        PEPL_PORT_HANDLE portHandle,
    		uint32_t baseAddr, uint32_t phyAddr,
        NS_BOOL enableFlag);

void
    PTPSetTriggerConfig(
//        PEPL_PORT_HANDLE portHandle,
    		uint32_t baseAddr, uint32_t phyAddr,
        NS_UINT trigger,
        NS_UINT triggerBehavior,
        NS_UINT gpioConnection);

void
    PTPSetTriggerConfig(
//        PEPL_PORT_HANDLE portHandle,
    		uint32_t baseAddr, uint32_t phyAddr,
        NS_UINT trigger,
        NS_UINT triggerBehavior,
        NS_UINT gpioConnection);

void
    PTPSetEventConfig (
//        PEPL_PORT_HANDLE portHandle,
    		uint32_t baseAddr, uint32_t phyAddr,
        NS_UINT event,
        NS_BOOL eventRiseFlag,
        NS_BOOL eventFallFlag,
        NS_BOOL eventSingle,
        NS_UINT gpioConnection);

void
    PTPSetTransmitConfig (
//        PEPL_PORT_HANDLE portHandle,
    		uint32_t baseAddr, uint32_t phyAddr,
        NS_UINT txConfigOptions,
        NS_UINT ptpVersion,
        NS_UINT ptpFirstByteMask,
        NS_UINT ptpFirstByteData);

void
    PTPSetPhyStatusFrameConfig (
//        PEPL_PORT_HANDLE portHandle,
    		uint32_t baseAddr, uint32_t phyAddr,
        NS_UINT statusConfigOptions,
        MAC_SRC_ADDRESS_ENUM srcAddrToUse,
        NS_UINT minPreamble,
        NS_UINT ptpReserved,
        NS_UINT ptpVersion,
        NS_UINT transportSpecific,
        NS_UINT8 messageType,
        NS_UINT32 sourceIpAddress);

void
    PTPSetReceiveConfig (
//        PEPL_PORT_HANDLE portHandle,
    		uint32_t baseAddr, uint32_t phyAddr,
        NS_UINT rxConfigOptions,
        RX_CFG_ITEMS *rxConfigItems);

NS_UINT
    PTPCalcSourceIdHash (
        NS_UINT8 *tenBytesData);

void
    PTPSetTempRateDurationConfig (
//        PEPL_PORT_HANDLE portHandle,
    		uint32_t baseAddr, uint32_t phyAddr,
        NS_UINT32 duration);

void
    PTPSetClockConfig (
//        PEPL_PORT_HANDLE portHandle,
    		uint32_t baseAddr, uint32_t phyAddr,
        NS_UINT clockConfigOptions,
        NS_UINT ptpClockDivideByValue,
        NS_UINT ptpClockSource,
        NS_UINT ptpClockSourcePeriod);

void
    PTPSetGpioInterruptConfig (
//        PEPL_PORT_HANDLE portHandle,
    		uint32_t baseAddr, uint32_t phyAddr,
        NS_UINT gpioInt);

void
    PTPSetMiscConfig (
//        PEPL_PORT_HANDLE portHandle,
    		uint32_t baseAddr, uint32_t phyAddr,
        NS_UINT ptpEtherType,
        NS_UINT ptpOffset,
        NS_UINT txSfdGpio,
        NS_UINT rxSfdGpio);

void
    PTPClockStepAdjustment (
//        PEPL_PORT_HANDLE portHandle,
    		uint32_t baseAddr, uint32_t phyAddr,
        NS_UINT32 numberOfSeconds,
        NS_UINT32 numberOfNanoSeconds,
        NS_BOOL negativeAdj);

void
    PTPClockSet (
//        PEPL_PORT_HANDLE portHandle,
    		uint32_t baseAddr, uint32_t phyAddr,
        NS_UINT32 numberOfSeconds,
        NS_UINT32 numberOfNanoSeconds);

void
    PTPClockSetRateAdjustment (
//        PEPL_PORT_HANDLE portHandle,
    		uint32_t baseAddr, uint32_t phyAddr,
        NS_UINT32 rateAdjValue,
        NS_BOOL tempAdjFlag,
        NS_BOOL adjDirectionFlag);

NS_UINT
    PTPCheckForEvents (
//        PEPL_PORT_HANDLE portHandle);
    		uint32_t baseAddr, uint32_t phyAddr);

void PTPArmTrigger (
//        PEPL_PORT_HANDLE portHandle,
    		uint32_t baseAddr, uint32_t phyAddr,
        NS_UINT trigger,
        NS_UINT32 expireTimeSeconds,
        NS_UINT32 expireTimeNanoSeconds,
        NS_BOOL initialStateFlag,
        NS_BOOL waitForRolloverFlag,
        NS_UINT32 pulseWidth,
        NS_UINT32 pulseWidth2);

boolean PTPHasTriggerExpired (
//        PEPL_PORT_HANDLE portHandle,
    		uint32_t baseAddr, uint32_t phyAddr,
        NS_UINT trigger);

void
    PTPCancelTrigger (
//        PEPL_PORT_HANDLE portHandle,
    		uint32_t baseAddr, uint32_t phyAddr,
        NS_UINT trigger);

NS_UINT
    MonitorGpioSignals (
//        PEPL_PORT_HANDLE portHandle
    		uint32_t baseAddr, uint32_t phyAddr
		);

void
    PTPClockReadCurrent (
//        PEPL_PORT_HANDLE portHandle,
    		uint32_t baseAddr, uint32_t phyAddr,
        NS_UINT32 *retNumberOfSeconds,
        NS_UINT32 *retNumberOfNanoSeconds);

void
    PTPGetTransmitTimestamp (
//        PEPL_PORT_HANDLE portHandle,
    		uint32_t baseAddr, uint32_t phyAddr,
        NS_UINT32 *retNumberOfSeconds,
        NS_UINT32 *retNumberOfNanoSeconds,
        NS_UINT   *overflowCount);

void
    PTPGetReceiveTimestamp (
//        PEPL_PORT_HANDLE portHandle,
    		uint32_t baseAddr, uint32_t phyAddr,
        NS_UINT32 *retNumberOfSeconds,
        NS_UINT32 *retNumberOfNanoSeconds,
        NS_UINT *overflowCount,
        NS_UINT *sequenceId,
        NS_UINT8 *messageType,
        NS_UINT *hashValue);

void
    PTPGetTimestampFromFrame (
//        PEPL_PORT_HANDLE portHandle,
    		uint32_t baseAddr, uint32_t phyAddr,
        NS_UINT8 *receiveFrameData,
        NS_UINT32 *retNumberOfSeconds,
        NS_UINT32 *retNumberOfNanoSeconds);

NS_BOOL
    PTPGetEvent (
//        PEPL_PORT_HANDLE portHandle,
    		uint32_t baseAddr, uint32_t phyAddr,
        NS_UINT   *eventBits,
        NS_UINT   *riseFlags,
        NS_UINT32 *eventTimeSeconds,
        NS_UINT32 *eventTimeNanoSeconds,
        NS_UINT   *eventsMissed);

NS_UINT8 *
    IsPhyStatusFrame (
//		PEPL_PORT_HANDLE portHandle,
    		uint32_t baseAddr, uint32_t phyAddr,
        NS_UINT8 *frameBuffer,
        NS_UINT16 frameLength);

NS_UINT8 *
    GetNextPhyMessage (
//		PEPL_PORT_HANDLE portHandle,
    		uint32_t baseAddr, uint32_t phyAddr,
        NS_UINT8 *msgLocation,
        PHYMSG_MESSAGE_TYPE_ENUM *messageType,
        PHYMSG_MESSAGE *message);

#ifdef __cplusplus
}
#endif


#endif // _EPL_1588_INCLUDE
